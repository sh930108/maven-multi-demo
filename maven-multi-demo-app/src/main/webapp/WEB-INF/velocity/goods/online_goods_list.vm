##
#set($layout="/admin/layout/matrix.vm")
#parse("/admin/com/common.vm")
<script type="text/javascript">
    Matrix.Nav({"menu": 107, "cmenu": 111});
</script>
<style>
    .form-horizontal-inline .control-label{width: 150px;}
    .form-horizontal-inline .controls{margin-left: 160px;}
</style>
<div id="content-header">
    <h1>商品管理 | 已通过商品</h1>
</div>

<div class="container-fluid">
    <hr>
    <div class="row-fluid">
        <div class="span12">
            <div class="widget-box">
                <div class="widget-title"> <span class="icon"> <i class="icon-align-justify"></i> </span>
                    <h5>已通过商品列表</h5>
                </div>
                <div class="widget-content nopadding">
                    #if($online==1)
                    <form class="form-horizontal form-horizontal-inline" method="get" id="frm" action="$!{request.getContextPath()}/gb/goods/queryOnlineGoodsList.do">
                        <input type="hidden" name="orderType" id="orderTypeId" value="$!{request.getParameter('orderType')}"/>
                    #else
                    <form class="form-horizontal form-horizontal-inline" method="get" id="frm" action="$!{request.getContextPath()}/gb/goods/queryCheckPassGoodsList.do" >
                    #end
                    <div class="row-fluid">
                        <div class="span4">
                            <div class="control-group">
                                <label class="control-label">商品ID：</label>
                                <div class="controls">
                                    <input type="text" placeholder="" class="span8" name="styleNumId" value="$!{request.getParameter('styleNumId')}">
                                </div>
                            </div>
                        </div>
                        <div class="span4">
                            <div class="control-group">
                                <label class="control-label">商品标题：</label>
                                <div class="controls">
                                    <input type="text" placeholder="" class="span8" name="styleTitle" value="$!{request.getParameter('styleTitle')}">
                                </div>
                            </div>
                        </div>
                        <div class="span4">
                            <div class="control-group">
                                <label class="control-label">款式编码：</label>
                                <div class="controls">
                                    <input type="text" placeholder="" class="span8" name="styleId" value="$!{request.getParameter('styleId')}">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row-fluid">
                        <div class="span8">
                            <div class="control-group">
                                <label class="control-label">商品类目：</label>
                                <div class="controls">
                                    <select id="t1" name="styleCatelogFirst" onchange="ch2(this.value)" onsubmit="return checkSubmit();">
                                        <option value="0">请选择</option>
                                        #foreach($g in $glist)
                                            <option value="$g.gtId" #if($!{request.getParameter('styleCatelogFirst')}==$g.gtId) selected #end>$g.gtName</option>
                                        #end
                                    </select>
                                    <select id="t2" name="styleCatelogSec" onchange="ch3(this.value)">
                                        <option value="0">请选择</option>
                                    </select>
                                    <select id="t3" name="styleCatelogThird" >
                                        <option value="0">请选择</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="row-fluid">
                        <div class="span8">
                            <div class="control-group">
                                <label class="control-label">商品状态：</label>
                                <div class="controls">
                                    <select name="isHide">
                                        <option value="">请选择</option>
                                        <option value="1" #if($!request.getParameter('isHide') == 1) selected #end>已隐藏</option>
                                        <option value="0" #if($!request.getParameter('isHide') == 0) selected #end>未隐藏</option>
                                    </select>
                                    <input type="checkbox" name="isTotalStorageSend" value="1" #if($!request.getParameter('isTotalStorageSend') == 1)checked #end>总仓发货
                                </div>
                            </div>
                        </div>

                        <div class="span4">
                            <div class="form-actions">
                                <input  type="hidden" name="online" value="$!{online}"/>
                                <input  type="hidden" name="type" value="$!{type}"/>
                                <button class="btn btn-success" type="submit" id="next">筛选</button>
                                <button class="btn btn-warning" type="reset">重置</button>
                                <div class="btn-group tip-right" data-original-title="由于数据量大，导出速度比较慢，请点击“生成数据”，稍后再进行数据下载(导出excel表格)。">
                                    <button class="btn btn-danger dropdown-toggle" data-toggle="dropdown">导出 <span class="caret"></span></button>
                                    <ul class="dropdown-menu" id="exportOrder"></ul>
                                </div>
                            </div>
                        </div>

                    </div>
                </form>

                </div>
                <div class="widget-content">
                    <div class="widget-box widget-tabs-box">
                        <ul class="nav nav-tabs">
                            <li>
                                <a href="$!{request.getContextPath()}/allgoods/getPassGoodsPageList.do">全部</a>
                            </li>
                            <li class="#if($online==1)active#end">
                                <a href="$!{request.getContextPath()}/gb/goods/queryOnlineGoodsList.do?online=1&amp;type=1">已上架</a>
                            </li>
                            <li class="#if($online==0)active#end">
                                <a href="$!{request.getContextPath()}/gb/goods/queryCheckPassGoodsList.do?online=0">已下架</a>
                            </li>
                            <li>
                                <a href="$!{request.getContextPath()}/gb/goods/queryOnlineNoStockGoodsList.do?type=2">已售罄</a>
                            </li>
                        </ul>
                        #if($online==1)
                            <div class="widget-content tab-content">
                                <table class="table table-hover with-check table-text-center table-order">
                                    <thead>
                                    <th>
                                        <label for="checkbox-01" class="label_check">
                                            <input type="checkbox" id="checkAll" name="sample-checkbox-01" />
                                        </label>
                                    </th>
                                    <th class="text-left">商品</th>
                                    <th style="width: 150px;">商品ID</th>
                                    <th>款式编码</th>
                                    <th>商品库存</th>
                                    <th>
                                        <a class="btn_p order" href="javascript:void(0)" onclick="doOrder(this)"  orderType="1">总销量<span>↑</span>
                                        </a>
                                    </th>
                                    <th>所属一级类目</th>
                                    ## <th>在售门店数</th>
                                    <th>是否隐藏</th>
                                    <th>是否总仓发货</th>
                                    <th>上架时间</th>
                                    <th>操作</th>
                                    </thead>
                                    <tbody>
                                        #foreach($data in ${dataList})
                                            #set($index = $loopCounter + 1)
                                        <tr >
                                            <td>
                                                <label for="checkbox-$index" class="label_check">
                                                    <input type="checkbox" id="checkbox-$index" value="$data.styleNumId" name="gtIds" />
                                                </label>
                                            </td>
                                            <td class="text-left baobei">
                                        	<span class="pic">
                                                #if("$!{data.goodsPic}"=="")
                                                    <img src="http://s.mamhao.cn/admin/bootstrap/img/photo-default.png" />
                                                #else
                                                    <img src="$goodsImagePath/$data.styleId/$!{data.goodsPic}" />
                                                #end
                                          </span>
                                                <div class="desc">
                                                    <p>
                                                        <a href="javascript:void(0)" onclick="showHtml(this,'$!{data.styleNumId}')">
                                                            #if($null.isNull($data.styleTitle))
                                                	
                                                #else
                                                                $!{data.styleTitle}
                                                            #end
                                                        </a>
                                                    <p>
                                                    ## #if($!{data.cStyleNumId})
                                                    ## 判断是否微分销字段不确定
                                                        #if($!{data.roleId})
                                                            <span class="label label-important">微分销</span>
                                                        #end
                                                    </p>
                                                    </p>
                                                </div>
                                            </td>
                                            <td>$data.styleNumId</td>
                                            <td>$data.styleId</td>
                                            <td>
                                                <a href="javscript:void(0)" onclick="javascript:showItem('$data.styleNumId',' $!{data.styleTitle}',this,1,$data.istotalSend)">
                                                    #if("$!{data.stockCount}"=="")
                                                        0
                                                    #else
                                                        $!{data.stockCount}
                                                    #end
                                                </a>
                                            </td>
                                            <td>$!{data.totalSaleCount}</td>
                                            <td>
                                                #if($null.isNull($data.firstName))
                                            #else
                                                    $!{data.firstName}
                                                #end
                                            </td>
                                        ## <td>10</td>
                                            <td>
                                                <input type="checkbox" class="recomme" #if($data.isHide == 1) checked #end value="$data.styleNumId"/>
                                            </td>
                                            <td>
                                                <input type="checkbox" class="totalStorageSend" #if($data.istotalSend==1) checked #end value="$data.styleNumId"/>
                                            </td>
                                            <td>
                                                $!date.format('yyyy-MM-dd HH:dd:mm',$!data.onlineTime)
                                            </td>
                                            <td>
                                                <p><a class="btn btn-warning btn-mini" href="$!{request.getContextPath()}/gb/goods/index.do?gtNo=$data.styleNumId">编辑</a>
                                                ##<a class="btn btn-danger btn-mini" onclick="putGoodsOnByIds('$data.styleNumId')" href="javascript:void(0)">下架</a></p>
                                                    <a class="btn btn-danger btn-mini" onclick="showSingleModal('downReasonModal','$data.styleTitle','$data.styleNumId')" href="javascript:void(0)">下架</a></p>
                                                <p><a class="btn btn-danger btn-mini" onclick="refreshObject('$data.styleId')" href="javascript:void(0)">刷新缓存</a> <a class="btn btn-primary btn-mini" href="$!{request.getContextPath()}/gb/goods/showPromotion.do?styleNumId=$data.styleNumId&styleId=$data.styleId&online=$!{request.getParameter('online')}&type=$!{request.getParameter('type')}&page=$!{request.getParameter('page')}">品牌宣导</a></p>
                                            </td>
                                        </tr>
                                        #end
                                    </tbody>

                                </table>
                                #parse("/pagination.vm")
                                <button type="button" class="btn btn-danger" id="putGoodsOn">批量下架</button>
                                <button type="button" class="btn btn-info" onclick="javascript:showTotalSendModal();" style="display:none;">批量指定总仓发货</button>
                            </div>
                        #else
                            <div class="widget-content tab-content">
                                <table class="table table-hover with-check table-text-center table-order">
                                    <thead>
                                    <th>
                                        <label for="checkbox-01" class="label_check">
                                            <input type="checkbox" id="checkAll" name="sample-checkbox-01" />
                                        </label>
                                    </th>
                                    <th class="text-left">商品</th>
                                    <th style="width: 150px;">商品ID</th>
                                    <th>款式编码</th>
                                    <th>发布时间</th>
                                    <th>所属一级类目</th>
                                    <th>商品库存</th>
                                    <th>下架时间</th>
                                    <th>下架原因</th>
                                    <th>操作</th>
                                    </thead>
                                    <tbody>
                                        #foreach($data in ${dataList})
                                            #set($index = $loopCounter + 1)
                                        <tr>
                                            <td>
                                                <label for="checkbox-$index" class="label_check">
                                                    <input type="checkbox" id="checkbox-$index" value="$data.styleNumId" name="gtIds" />
                                                </label>
                                            </td>
                                            <td class="text-left baobei">
                                            <span class="pic">
                                                #if("$!{data.goodsPic}"=="")
                                                    <img src="$goodsImagePath/$data.styleId/$!{data.goodsPic}" class="commodity_pic" width="60" height="60" alt=""/>
                                                #else
                                                    <img src="$goodsImagePath/$data.styleId/$!{data.goodsPic}" class="commodity_pic" width="60" height="60" alt=""/>
                                                #end
                                            </span>
                                                <div class="desc">
                                                    <p>
                                                        <a href="javascript:void(0)" onclick="showHtml(this,'$!{data.styleNumId}')">
                                                            #if($null.isNull($data.styleTitle))
                                                        #else
                                                                $!{data.styleTitle}
                                                            #end
                                                        </a>
                                                    </p>
                                                </div>
                                            </td>
                                            <td>$data.styleNumId</td>
                                            <td>$data.styleId</td>

                                            <td>
                                                #if("$!{data.createTime}"=="")
                                            #else
                                                    $!date.format('yyyy-MM-dd HH:mm:ss ',$!{data.createTime})
                                                #end
                                            </td>
                                            <td>
                                                #if($null.isNull($data.firstName))
                                            #else
                                                    $!{data.firstName}
                                                #end
                                            </td>
                                            <td>
                                            ##<a href="javscript:void(0)" onclick="javascript:showItem('$data.styleNumId',' $!{data.styleTitle}',this,0)">
                                                #if("$!{data.stockCount}"=="")
                                                    0
                                                #else
                                                    $!{data.stockCount}
                                                #end
                                            ## </a>
                                            </td>
                                            <td>
                                                $!date.format('yyyy-MM-dd HH:mm:ss ',$!{data.onlineTime})
                                            </td>
                                            <td>
                                                $!{data.downReason}
                                                #*<span class="badge badge-important">已下架</span>
                                                <p>
                                                    <a  class="badge badge-important" onclick="showDownReasonModal('showDownReasonModal','$!{data.styleTitle}','$!{data.downReason}')" href="javascript:void(0)">查看原因</a>
                                                </p>
                                                *#
                                            </td>
                                            <td>
                                                <p><a class="btn btn-warning btn-mini" href="$!{request.getContextPath()}/gb/goods/index.do?gtNo=$data.styleNumId">编辑</a>
                                                    <a class="btn btn-success btn-mini" onclick="putGoodsDownByIds('$data.styleNumId')" href="javascript:void(0)">上架</a></p>
                                                <p><a class="btn btn-danger btn-mini" onclick="refreshObject('$data.styleId')" href="javascript:void(0)">刷新缓存</a> <a class="btn btn-primary btn-mini" href="$!{request.getContextPath()}/gb/goods/showPromotion.do?styleNumId=$data.styleNumId&styleId=$data.styleId&online=$!{request.getParameter('online')}&type=$!{request.getParameter('type')}&page=$!{request.getParameter('page')}">品牌宣导</a></p>
                                            </td>
                                        </tr>
                                        #end
                                    </tbody>
                                </table>
                                #parse("/pagination.vm")
                                <button type="button" class="btn btn-success" id="putGoodsDown">批量上架</button>
                            </div>
                        #end

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--modal container-->
<div class="js-tmp-modal modal modal-lg hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>商品库存</h3>
    </div>
    <div class="modal-body nopadding">
        <div class="model-iframe"></div>
    </div>
    <div class="modal-footer">
        <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
    </div>
</div>
<!--下架原因弹框-->
<div aria-hidden="false" id="downReasonModal" class="modal hide in">
    <div class="modal-header">
        <button data-dismiss="modal" class="close" type="button">×</button>
        <h3></h3>
    </div>
    <div class="modal-body">
        <div class="row-fluid">
            <div class="span12">
                <div class="control-group">
                    <label class="control-label">下架原因：</label>
                    <div class="controls">
                        <select id="downReasonTxt1">
                            <option value="">请选择下架原因</option>
                            <option value="商品超卖">商品超卖</option>
                            <option value="商品描述有问题，待事业部确认">商品描述有问题，待事业部确认</option>
                            <option value="库存为零">库存为零</option>
                            <option value="价格低于限价">价格低于限价</option>
                            <option value="bug问题">bug问题</option>
                            <option value="事业部要求下架商品">事业部要求下架商品</option>
                            <option value="其他">其他</option>
                        </select>
                        <textarea id="reason" placeholder="还可以写其他原因..." maxlength="100"></textarea>
                        <input type="hidden" id="downStyleNumId" />
                        <input type="hidden" id="downStyleType" />
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-success" type="button" id="submitReason">提交</button>
        <a data-dismiss="modal" class="btn" href="javascript:;">关闭</a>
    </div>
</div>
<!--查看原因弹框-->
<div aria-hidden="false" id="showDownReasonModal" class="modal hide in">
    <div class="modal-header">
        <button data-dismiss="modal" class="close" type="button">×</button>
        <h3></h3>
    </div>
    <div class="modal-body">
        <p></p>
    </div>
    <div class="modal-footer">
    ##        <button class="btn btn-success" type="button" onclick="copyRefuseReason()" id="copyReason">复制</button>
        <a data-dismiss="modal" class="btn" href="javascript:;">关闭</a>
    </div>
</div>


<!--批量修改安全库存-->
<div class="js-safestock-modal modal hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>批量设置安全库存</h3>
    </div>
    <div class="modal-body">
        库存数： <input type="text" id="safeStock"/><span class="label label-important">不勾选将设置所有款式的安全库存</span>
    </div>
    <div class="modal-footer">
        <button class="btn btn-success" type="button" onclick="javascript:batchUpdateSafeStock();">提交</button>
        <a data-dismiss="modal" class="btn" href="javascript:;">关闭</a>
    </div>
</div>



#*批量指定总仓发货*#
<div class="js-total_send-modal modal hide fade">
    <form  action='$!{request.getContextPath()}/gb/goods/localImportTotalSend.do' method="POST" enctype="multipart/form-data">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>批量导入指定总仓发货</h3>
        </div>
        <div class="modal-body">
            <input type="file" name="file"  accept=".xls,.xlsx"/>
            <select name="flag">
                <option value="0">取消指定总仓发货</option>
                <option value="1">指定总仓发货</option>
            </select>
        </div>
        <div class="modal-footer">
            <button class="btn btn-success" type="submit">提交</button>
            <a data-dismiss="modal" class="btn" href="javascript:;">关闭</a>
        </div>
    </form>
</div>

<script>
    //获取正在导出的导出数据
    function buildingOrderExport(){
        Matrix.JSON({
            showLoad: true,
            type: "POST",
            url: root + "/exportNts/queryExportNotice.do",
            val:{"status" : 1, "type" : 7},
            fun: function(result){
                var result = eval(result);
                if(result != null){
                    //数据正在导出中
                    var html = '<li><a href="javascript:void(0)">正在生成数据，请稍后下载（数据更新时间：'+getLocalTime(result.createTime)+'）</a></li>';
                    $("#exportOrder").append(html);
                }else{
                    var html = '<li><a href="javascript:exportExcel();">生成数据（后台生成数据，稍后才能进行导出）</a></li>';
                    $("#exportOrder").append(html);
                }
            }
        });
    }
    buildingOrderExport();


    //获取排名下载列表
    function buildOrderExport(){
        Matrix.JSON({
            showLoad: true,
            type: "POST",
            url: root + "/exportNts/queryExportNotice.do",
            val:{"status" : 2, "type" : 7},
            fun: function(result){
                if(result){
                    //数据已完成导出
                    var html = '<li><a href="'+root+"/"+result.message+'">数据下载（数据更新时间：'+getLocalTime(result.updateTime)+'）</a></li>';
                    $("#exportOrder").append(html);
                }
            }
        });
    }
    buildOrderExport();

    //日期函数
    function getLocalTime(nS) {
        return new Date(parseInt(nS)).toLocaleString().replace(/年|月/g, "-").replace(/日/g, " ");
    }

    //导出excel
    function exportExcel(){
        $("#frm").attr("action",root + "/allgoods/exportItemStock.do")
        $("#frm").submit();
        $("#frm").attr("action",root + "/gb/goods/queryOnlineGoodsList.do?online=1&type=1")
    }


    $('#next').click(function () {
        var styleNumId = $("input[name='styleNumId']");
        if(styleNumId.val() && !isForm.isImp(styleNumId.val())){
            Toast.show("请输入正确的款式编号");
            return false;
        }
        $('#frm').submit();
    });



    var gtId1 = "$!{request.getParameter('styleCatelogFirst')}";
    var gtId2 = "$!{request.getParameter('styleCatelogSec')}";
    var gtId3 = "$!{request.getParameter('styleCatelogThird')}";
    if(gtId1 != ""){
        ch2(gtId1);
        if(gtId2 != ""){
            ch3(gtId2);

        }
    }
    function ch2(id){
        if(id==0){
            return;
        }
        $.get("$!{request.getContextPath()}/goods/queryId.do", {
            'id' : id
        }, function(data) {
            var str = '<option value=\"0\">请选择</option>';
            $.each(data, function(i, n) {
                if(gtId2 != ""){
                    if(gtId2==n.gtId){
                        str += "<option value='"+n.gtId+"' selected >"+n.gtName+"</option>";
                    }else{
                        str += "<option value='"+n.gtId+"'>"+n.gtName+"</option>";
                    }
                }else{
                    str += "<option value='"+n.gtId+"'>"+n.gtName+"</option>";
                }

            });
            $('#t2').html(str);
            $('#t3').val(0);
        });
    }
    function ch3(id){
        if(id==0){
            return;
        }
        $.get("$!{request.getContextPath()}/goods/queryId.do", {
            'id' : id
        }, function(data) {
            var str = '<option value=\"0\">请选择</option>';
            $.each(data, function(i, n) {
                if(gtId3 != ""){
                    if(gtId3==n.gtId){
                        str += "<option value='"+n.gtId+"' selected >"+n.gtName+"</option>";
                    }else{
                        str += "<option value='"+n.gtId+"'>"+n.gtName+"</option>";
                    }
                }else{
                    str += "<option value='"+n.gtId+"'>"+n.gtName+"</option>";
                }
            });
            $('#t3').html(str);
        });
    }

    $(function () {
        showOrder();
    });

    function showOrder() {
        var orderType = "$!request.getParameter('orderType')";
        if (orderType != "") {
            if (orderType === "0") {
                var $obj = $(".order[orderType = " + orderType + "]");
                    $obj.children("span").text("↑");
                    $obj.attr("orderType", 1);
            } else {
                var $obj = $(".order[orderType = " + orderType + "]");
                    $obj.children("span").text("↓");
                    $obj.attr("orderType", 0);
            }

        }
    }

    //排序
    function doOrder(obj) {
        var orderType = $(obj).attr("orderType");
        //var url = "$!{request.getContextPath()}/gb/goods/queryOnlineGoodsList.do?type=1&online=1&orderType=" + orderType;
        //location.href = url;

        $('#orderTypeId').val(orderType);
        frm.submit();
    }


    function showSendCount(obj, companyId, gtId, count) {
        //加载iframe
        var info = {
            title: "",
            url: "$!{request.getContextPath()}/goods/queryCallGoodsRecordList.do?companyId=" + companyId + "&gtId=" + gtId + "&sendCount=" + count
        };
        loadIframe(info);
    }

    function showSendOnHandCount(obj, shopId, gtId, count) {
        //加载iframe
        var info = {
            title: "",
            url: "$!{request.getContextPath()}/goods/queryCallOnAddGoodsRecordList.do?shopId=" + shopId + "&gtId=" + gtId + "&onHand=" + count
        };
        loadIframe(info);
    }

    /*全选*/
    $("#checkAll").click(function () {
        Matrix.CheckedAll($(".table-order"));
    });

    $('#putGoodsOn').click(function () {
        var ids = "";
        $("input[name='gtIds']:checked").each(function () {
            ids += $(this).val() + ",";
        })
        if (ids != "" && confirm("是否确定下架已选商品")) {
            $.ajax({
                url: '$!{request.getContextPath()}/gb/goods/batchUpdateGoodsStyleStatus.do',// 跳转到 action
                data: {operateStyles: ids, online: 0},
                type: 'get',
                cache: false,
                success: function (data) {
                    data = eval("(" + data + ")");
                    if (data.success == 0) {
                        Toast.show("更新失败");
                    } else {
                        Toast.show("更新成功");
                        window.location.reload();
                    }
                },
                error: function () {
                    Toast.show("系统异常！");
                }
            });
        } else {
            Toast.show("请选择您要下架的商品");
        }
    });

    $('#putGoodsDown').click(function () {
        var ids = "";
        $("input[name='gtIds']:checked").each(function () {
            ids += $(this).val() + ",";
        });
        if (ids != "" && confirm("是否确定上架已选商品")) {
            Matrix.JSON({
                url: "$!{request.getContextPath()}/gb/goods/batchUpdateGoodsStyleStatus.do",
                val: {operateStyles: ids, online: 1},
                fun: function (data) {
                    if (data.success == 0) {
                        Toast.show("更新失败,"+data.msg);
                    } else {
                        window.location.reload();
                    }
                }
            });
        } else {
            Toast.show("请选择您要上架的商品");
        }
    });

    function putGoodsOnByIds(id) {
        if(confirm("是否确定下架该商品")){
            Matrix.JSON({
                url: "$!{request.getContextPath()}/gb/goods/batchUpdateGoodsStyleStatus.do",
                val: {operateStyles: id, online: 0},
                fun: function (data) {
                    if (data.success == 0) {
                        Toast.show("更新失败,");
                    } else {
                        Toast.show({
                            template: "更新成功",
                            callback: function () {
                                window.location.reload();
                            }
                        });
                    }
                }
            });
        }
    }

    function putGoodsDownByIds(id) {
        if(confirm("是否确定上架该商品")){
            Matrix.JSON({
                url: "$!{request.getContextPath()}/gb/goods/batchUpdateGoodsStyleStatus.do",
                val: {operateStyles: id, online: 1},
                fun: function (data) {
                    if (data.success == 0) {
                        Toast.show("更新失败,"+data.msg);
                    } else {
                        window.location.reload();
                    }
                }
            });
        }

    }

    /*显示商品库存情况*/
    function showItem(styleNumId, styleId, obj,online,istotalSend) {
        //加载iframe
        var info = {
            title: styleId,
            url: "$!{request.getContextPath()}/gb/goods/queryOnlineGoodsStock.do?styleNumId=" + styleNumId + "&styleId=" + styleId+"&online="+online+"&totalWarehouseSend="+istotalSend
        };
        loadIframe(info);
    }
    ##款式平台推荐
    #* 取消平台推荐功能
    $('.recomme').on("click", function () {
        var checked = $(this).attr("checked");
        if (checked) {
            Matrix.JSON({
                url: "$!{request.getContextPath()}/gb/goods/updateStyleIsRecomme.do",
                val: {styleNumId: $(this).val(), type: 1},
                fun: function (data) {
                    window.location.reload();
                }
            });
        } else {

            Matrix.JSON({
                url: "$!{request.getContextPath()}/gb/goods/updateStyleIsRecomme.do",
                val: {styleNumId: $(this).val(), type: 0},
                fun: function (data) {
                    window.location.reload();
                }
            });
        }
    });
    *#

    ##款式是否隐藏
    $('.recomme').on("click", function () {
        var checked = $(this).attr("checked");
        if (checked) {
            if(!confirm("是否隐藏该商品?\n隐藏的商品只在扫码的场景出现!")){
                return;
            }
        }else{
            if(!confirm("是否取消隐藏？")){
                return;
            }
        }

        Matrix.JSON({
            url: "$!{request.getContextPath()}/gb/goods/updateStyleIsHide.do",
            val: {styleNumId: $(this).val(), isHide : checked ? 1 : 0},
            fun: function (data) {
                window.location.reload();
            }
        });
    });


    //是否总仓发货
    $('.totalStorageSend').on("click", function () {
        var checked = $(this).attr("checked");
        if (checked) {
            if(!confirm("是否指定仅总仓发货？\n指定后将下架所有分公司该商品！")){
                return;
            }
            Matrix.JSON({
                url: "$!{request.getContextPath()}/gb/goods/updateStyleIsTotalStorage.do",
                val: {styleNumId: $(this).val(), isStorageSend: 1},
                fun: function (data) {
                    window.location.reload();
                }
            });
        } else {
            if(!confirm("是否取消指定仅总仓发货？\n取消后将恢复上架所有有库存分公司该商品！")){
                return;
            }
            Matrix.JSON({
                url: "$!{request.getContextPath()}/gb/goods/updateStyleIsTotalStorage.do",
                val: {styleNumId: $(this).val(), isStorageSend: 0},
                fun: function (data) {
                    window.location.reload();
                }
            });
        }
    });

    /*加载iframe*/
    function loadIframe(info) {
        var self = $(".js-tmp-modal");
        self.find(".modal-body .model-iframe").empty().append("<iframe src='" + info.url + "' />");
        self.find(".modal-header h3").text(info.title);
        self.modal("show");
        return false;
    }

    /*显示商品详情*/
    function showHtml(obj, id) {
        Mobile.show({
            title: "商品详情",
            href: "$!{request.getContextPath()}/gb/goods/previewGoodsInfo.do?tepId=" + id
        });
    }

    // 显示审核拒绝理由窗口
    function showSingleModal(divId, title,styleNumId) {
        var m = $("#" + divId);
        m.find("h3").html(title);
        //m.find(".modal-body").html("<p>" + content + "</p>");
        $("#downStyleNumId").val(styleNumId);
        //$("#reasonStyleType").val(2);
        m.modal("show");
    }
    $('#submitReason').click(function () {
        var reason = $('#reason').val();
        var reasonChoose = $("#downReasonTxt1").val();
        if (reason == "" && reasonChoose == '') {
            Toast.show("请选择下架理由");
            $('#reason').focus();
            return;
        }

        if(reason.length){
            reason += ";" + reasonChoose;
        }else{
            reason = reasonChoose;
        }

        Matrix.JSON({
            url: "$!{request.getContextPath()}/gb/goods/batchUpdateGoodsStyleStatus.do",
            val: {operateStyles: $("#downStyleNumId").val(), online: 0,downReason: reason},
            fun: function (data) {
                if (data.success == 0) {
                    Toast.show("更新失败,");
                } else {
                    Toast.show({
                        template: "更新成功",
                        callback: function () {
                            window.location.reload();
                        }
                    });
                }
            }
        });
    });
    //显示查看拒绝理由窗口
    function showDownReasonModal(divId, title,content) {
        var m = $("#" + divId);
        m.find("h3").html(title);
        m.find(".modal-body").html("<p>" + content + "</p>");
        m.modal("show");
    }


    //设置安全库存
    $.each($("input[name='safeStock']"), function () {
        var self = $(this);
        self.data('val', self.val());
    });
    $("input[name='safeStock']").on("blur", function () {
        var self = $(this);
        if (self.data('val') !== self.val()) {
            updateSafeStock(self.attr("styleNumId"), self.val(), false);
        }
    });

    function updateSafeStock(styleNumIds, qty, fresh){
        if(qty == ''){
            return  Toast.show("请填写库存数");
        }else if(!isForm.isImp(qty)){
            return  Toast.show("请填写正整数");
        }

        var val = {qty : qty};
        if(styleNumIds != ''){
            val.styleNumIds = styleNumIds;
        }
        Matrix.JSON({
            showLoad: true,
            type: "POST",
            val: val,
            url: root + "/gb/goods/updateSafeStock.do",
            fun: function(res){
                if(res.success){
                    Toast.show(res.msg);
                    if(fresh){
                        window.location.reload();
                    }
                }else{
                    Toast.show(res.msg || "操作失败");
                }
            }
        });
    }


    //显示查看拒绝理由窗口
    function showUpdateSafeStockModal(){
        var modal = $(".js-safestock-modal");
        modal.modal();
    }

    function batchUpdateSafeStock(){
        var ids = "", qty = $("#safeStock").val();
        $("input[name='gtIds']:checked").each(function () {
            ids += $(this).val() + ",";
        });
        updateSafeStock(ids, qty, true);
    }


    function showTotalSendModal(){
        var modal = $(".js-total_send-modal");
        modal.modal();
    }

</script>
#parse("/goods/refresh.vm")