##订单详情
#parse("/admin/com/common.vm")
<script type="text/javascript" src="$!{request.getContextPath()}/res/uploadify/jquery.uploadify.min.js"></script>
#set($layout="/admin/layout/matrix.vm")
		<div id="content-header">
	    <h1>订单详情</h1>
	  </div>
    <div class="container-fluid">
    	<hr>
      <div class="row-fluid">
      	<div class="span12">
        	<div class="widget-box collapsible order-detail">
          	<div class="widget-title"><a href="#order-1" data-toggle="collapse"><span class="icon"><i class="icon-globe"></i></span><h5>订单状态</h5></a></div>
            <div id="order-1" class="collapse in">
            	<div class="widget-content">
              	<div class="order-id">
					订单号：
                  #if($order.parentOrderNo)
                    $!{order.orderNo}
                  #else
                    $!{order.orderBatchNo}
				  #end
				  (
					#if($order.relationType == 4)
                        代拍订单
					#else
						#if($order.platformSource==1)
							#if($order.orderType == 1)
                                普通订单
							#elseif($order.orderType == 2)
                                妈豆订单
							#elseif($order.orderType == 3)
                                POS订单
							#elseif($order.orderType == 4)
                                扫码订单
							#end
						#elseif($order.platformSource==2)
                            云订单
						#end
					#end
                    )
					
				  #if($order.state != 9 && $refundOrderLines.size() >0)
					<a href="#list" class="label label-warning">有$refundOrderLines.size()件退款退货商品</a>
				  #elseif($order.state == 9 && $refundOrderLines.size() >0)
					<a href="#list" class="label label-warning">全部商品退款退货</a>
				  #end
				#if($!{order.relationType} == 4)  #### 4为代拍订单
				#if($order.state == 5)
                    <a class="label label-important" data-toggle="modal" href="#confirmReceipt" >手动确认收货</a>
                    <div class="modal hide" id="confirmReceipt" style="width:320px;margin-left: -160px;" aria-hidden="true">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">×</button>
                            <h3>提示</h3>
                        </div>
                        <div class="modal-body ">
                            <p style="text-align:center;">确认手动确认收货吗？</p>
                        </div>
                        <div class="modal-footer"> <a href="javascript:;" class="btn btn-primary" data-dismiss="modal"onclick="javascript:confirmReceipt($!{order.orderNo})">确定</a> <a href="javascript:;" class="btn" data-dismiss="modal">关闭</a> </div>
                    </div>
				#end
				#end
                </div>
              	<div class="order-progress">
                	<div class="bg"><s></s></div>
                  #if($order.state == 0 || $order.state == 3 || $order.state == 4 || $order.state == 5 || $order.state == 6 )
					<ul class="clearfix">
                      	<li class="child"><span><strong>买家已下单</strong><del><s>1</s></del><em>$!date.format('yyyy-MM-dd HH:mm:ss',$!order.createdTime)</em></span></li>
                      	<li><span><strong>买家已付款</strong><del><s>2</s></del><em>$!date.format('yyyy-MM-dd HH:mm:ss',$!order.paymentTime)</em></span></li>
                        <li><span><strong>卖家已发货</strong><del><s>3</s></del><em>$!date.format('yyyy-MM-dd HH:mm:ss',$!order.deliveryTime)</em></span></li>
    					<li><span><strong>确认收货</strong><del><s>4</s></del><em>$!date.format('yyyy-MM-dd HH:mm:ss',$!order.confirmGoodTime)</em></span></li>
                        <li class="last"><span><strong>评价完成</strong><del><s>5</s></del><em>$!date.format('yyyy-MM-dd HH:mm:ss',$!order.finishTime)</em></span></li>
                    </ul>
                  #elseif($order.state == 1)
                  <ul class="clearfix">
                  	<li class="child"><span><strong>买家已下单</strong><del><s>1</s></del><em>$!date.format('yyyy-MM-dd HH:mm:ss',$!order.createdTime)</em></span></li>
                    <li class="last"><span><strong>订单已失效</strong><del><s>2</s></del><em>$!date.format('yyyy-MM-dd HH:mm:ss',$!order.expireTime)</em></span></li>
                  </ul>
                  #elseif($order.state == 2)
                  <ul class="clearfix">
                  	<li class="child"><span><strong>买家已下单</strong><del><s>1</s></del><em>$!date.format('yyyy-MM-dd HH:mm:ss',$!order.createdTime)</em></span></li>
                    <li class="last"><span><strong>订单已取消</strong><del><s>2</s></del><em>$!date.format('yyyy-MM-dd HH:mm:ss',$!order.cancelTime)</em></span></li>
                  </ul>
                  #elseif($order.state == 8)
                  <ul class="clearfix">
                  	<li class="child"><span><strong>买家已下单</strong><del><s>1</s></del><em>$!date.format('yyyy-MM-dd HH:mm:ss',$!order.createdTime)</em></span></li>
                    <li class="last"><span><strong>订单已删除</strong><del><s>2</s></del><em></em>$!date.format('yyyy-MM-dd HH:mm:ss',$!order.cancelTime)</span></li>
                  </ul>
				  #elseif($order.state == 9)
                  <ul class="clearfix">
                  	<li class="child"><span><strong>买家已下单</strong><del><s>1</s></del><em>$!date.format('yyyy-MM-dd HH:mm:ss',$!order.createdTime)</em></span></li>
                    <li class="last"><span><strong>已全部申请退款退货</strong><del><s>2</s></del><em></em></span></li>
                  </ul>
                  #else
                  	您的订单出现问题，请联系管理员~
                  #end
                </div>
              </div>
            </div>
            <div class="widget-title"><a href="#order-2" data-toggle="collapse"><span class="icon"><i class="icon-barcode"></i></span><h5>订单概况</h5></a></div>
            <div id="order-2" class="collapse in">
            	<div class="widget-content">
              	<dl>
                	<dt>收货人信息</dt>
                  <dd>
                  	<p><strong>收货人：</strong>$!{order.consigneeName}</p>
					<p><strong>收货区域：</strong>$!{gbCityArea.prvName} $!{gbCityArea.cityName} $!{gbCityArea.cityAreaName}</p>
                    <p><strong>收货地址：</strong>$!{order.address}</p>
                    <p><strong>联系电话：</strong>$!{order.consigneePhone}</p>
                    <p><strong>配送方式：</strong>#if($order.deliveryWay == 1)门店配送 #elseif($order.deliveryWay == 2)上门自提 #elseif($order.deliveryWay == 3)快递配送 #end</p>
                  </dd>
                </dl>
				<dl>
                	<dt>促销信息</dt>
					<dd>
						<p><strong>全场满减金额：￥ #formatAmount($!{order.orderPay.pmtAllReducePrice})</strong></p>
						<p><strong>部分满减金额：￥ #formatAmount($!{order.orderPay.pmtPartReducePrice})</strong></p>
						<p><strong>组合促销金额：￥ #formatAmount($!{order.orderPay.pmtGroupPrice})</strong></p>
						<p><strong>直降促销金额：￥ #formatAmount($!{order.orderPay.pmtSalePrice})</strong></p>
                        <p><strong>VIP会员优惠：￥ #formatAmount($!{order.orderPay.payVipReducePrice})</strong></p>
                    </dd>
                </dl>
                <dl>
                	<dt>付款信息</dt>
                  <dd>
                    <p><strong>付款方式：</strong>	
						#if($order.orderPay.payTypeId == 0)
							支付宝V1.0
						#elseif($order.orderPay.payTypeId == 1)
							银联支付
						#elseif($order.orderPay.payTypeId == 2)
							微信支付
						#elseif($order.orderPay.payTypeId == 3)
							妈豆支付
						#elseif($order.orderPay.payTypeId == 4)
							支付宝V1.1
						#elseif($order.orderPay.payTypeId == 5)
							公众号支付
						#elseif($order.orderPay.payTypeId == 6)
							测试支付宝类型
						#elseif($order.orderPay.payTypeId == 7)
                            代拍
						#else
							未付款
						#end
					</p>
                    <p><strong>商品金额：</strong>￥ #formatAmount($!{order.orderPay.payTotalPrice})</p>
                    <p><strong>运费金额：</strong>￥#formatAmount($!{order.orderPay.payFreightPrice})</p>
                    <p><strong>优惠券：</strong>￥#formatAmount($!{order.orderPay.payCouponPrice})</p>
                    <p><strong>妈豆抵扣：</strong>￥#formatAmount($!{order.orderPay.payMbeanPrice})</p>
                    <p><strong>GB抵扣：</strong>￥#formatAmount($!{order.orderPay.payGbPrice})</p>
                    <p><strong>MotherCare抵扣：</strong>￥#formatAmount($!{order.orderPay.payMothercarePrice})</p>
                    <p><strong>门店活动优惠：</strong>￥#formatAmount($!{order.orderPay.payShopActPrice})</p>
                    <p><strong>应支付金额：</strong><span class="label label-success">￥#formatAmount($!{order.orderPay.payPrice})</span></p>
                    <p><strong>付款时间：</strong>$!date.format('yyyy-MM-dd HH:mm:ss',$!order.paymentTime)</p>
                  	<p><strong>批次订单号：</strong>$!{orderBatchNo}</p>
				  </dd>
                </dl>
                    #if($order.platformSource == 2)
                        <dl>
                            <dt>接单信息</dt>
                            <dd>
                                <p><strong>接单店铺：</strong>$!{orderShop}</p>

                                <p><strong>冻结佣金：</strong>￥#formatAmount($!{freezeMoney})</p>

                                <p><strong>实收佣金：</strong>￥#formatAmount($!{incomeMoney})</p>
                            </dd>
                        </dl>
                    #end
                    <dl>
                        <dt>发货方收入</dt>
                        <dd>
                            <p><strong>收入金额：</strong>￥#formatAmount($!{sendShopIncomeMoney})</p>
                        </dd>
                    </dl>
                <dl>
                	<dt>发票信息</dt>
                  <dd>
                  	#if(!$order.invoiceTitle)
                    <p><strong>是否需要发票：</strong>否</p>
                    #else
                    <p><strong>发票类型：</strong>#if($order.invoiceType==1) 个人 #elseif($order.invoiceType==2) 公司   #end</p>
                    <p><strong>发票抬头：</strong>$!{order.invoiceTitle}</p>
                    #end
                  </dd>
                </dl>
				<dl>
					<dt>售后信息</dt>
					<dd>
                        <p><strong>售后门店：</strong>$!{onlineSubUnitName}</p>
                        <p><strong>售后公司：</strong>$!{companyName}</p>
					</dd>
				</dl>
					#if($!orderTransfer)
                        <dl>
                            <dt>转单信息</dt>
                            <dd>
                                <p><strong>转单门店：</strong>$!{orderTransfer.trShopName}</p>
                                <p><strong>转单地址：</strong>$!{orderTransfer.trAddress}</p>
                                <p><strong>收货人：</strong>$!{orderTransfer.trConsigneeName}</p>
                                <p><strong>联系方式：</strong>$!{orderTransfer.trConsigneeContact}</p>
                            </dd>
                        </dl>
					#end
				<dl>
					<dt>小额赔付信息</dt>
					<dd>
						#if($order.state == 0 || $order.state == 4 || $order.state == 5 || $order.state == 6)
							#if($!compensate)
                                <p><strong>赔付金额：</strong>￥ #formatAmount($!{compensate.cPrice})</p>
                                <p><strong>赔付原因：</strong>$!{compensate.cApplyCase}</p>
								#if($compensate.cState == 3)
                                    <p><strong>拒绝原因：</strong>$!{compensate.cVerifyPassCase}</p>
								#end
                                <p><strong>赔付状态：</strong>
									#if($compensate.cState == 0)
                                        完成
									#elseif($compensate.cState == 1)
                                        申请中
									#elseif($compensate.cState == 2)
                                        审核通过
									#elseif($compensate.cState == 3)
                                        审核拒绝
									#end
                                </p>
                                <p><strong>赔付发起时间：</strong>$!date.format('yyyy-MM-dd HH:mm:ss',$!{compensate.cApplyTime})</p>
                                <p>
                                    <strong>图片：</strong>
                                <ul class="thumbnails main" style="width: 30%">
									#if($!{compensate.cProofPics}!='')
										#set($plist=$compensate.cProofPics.split(','))
										#foreach($pic in $plist)
                                            <li>
                                                <img src="$imgpath$pic">
                                            </li>
										#end
									#end
                                </ul>
                                </p>
								#if( $compensate.cState == 3)
                                    <input id="compensateId" type="button" value="重新申请小额赔付" onclick="add(this);"/>
								#end
							#end
							#if(!$compensate)
                                <input id="compensateId" type="button" value="申请小额赔付" onclick="add(this);"/>
							#end
						#else
                            当前订单状态不支持小额赔付
						#end
					</dd>
				</dl>
				<a name="list"></a>
                <dl>
                	<dt>商品清单</dt>
                  <dd class="nopadding">
					#if($nonRefundOrderLines.size() && $nonRefundOrderLines.size() >= 1)
	                    <table class="table table-text-center table-order">
	                    	<thead>
				                  <tr>
				                    <th class="text-left">商品</th>
				                    <th>单价(元)</th>
									<th>促销价</th>
                                    <th>数量</th>
									<th>优惠</th>
				                    <th>来源</th>
                                      <th>实付款(元)</th>
				                    <th>订单状态</th>
				                  </tr>
				                </thead>
	                      <tbody>
	                      	<tr class="sep-row"><td colspan="5"></td></tr>
	                      	<tr class="order-hd">
		                        <td class="text-left column">
		                          <span class="buyers">买家：$!{order.consigneeName}</span>
	                            <span class="phone">手机：$!{order.consigneePhone}</span>
		                        </td>
                                <td colspan="9"></td>
								<td class="text-right"></td>
		                      </tr>
	                        #foreach($orderLine in $nonRefundOrderLines)
	                      	<tr class="order-bd">
	                        	<td class="text-left baobei">
	                            <a class="pic" href="javascript:;"><img src="$goodsImagePath$!{orderLine.picName}"></a>
	                            <div class="desc">
	                              <p><a class="baobei-name" href="javascript:;">$!{orderLine.itemName}</a></p>
	                              <small>$!{orderLine.spec}</small>
	                            </div>
									#if($!{order.orderType}==1)
	                               #if($!{order.relationType} == 4)  #### 4为代拍订单
	                                  #if($!order.state==4)
	                                        <a class="label label-important" data-toggle="modal" href="#tuikuan" >手动退款操作 </a>
                                            <div class="modal hide" id="tuikuan" style="width:320px;margin-left: -160px;" aria-hidden="true">
                                              <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal">×</button>
                                                <h3>提示</h3>
                                              </div>
                                              <div class="modal-body ">
                                                <p style="text-align:center;">确认退款吗？</p>
                                              </div>
                                              <div class="modal-footer"> <a href="javascript:void(0);" class="btn btn-primary" data-dismiss="modal" onclick="javascript:commitApplyRefund(2,$!{orderLine.itemId},#formatAmount($!{orderLine.payPrice}))">确定</a> <a href="javascript:;" class="btn" data-dismiss="modal">关闭</a> </div>
                                            </div>
	                                  #elseif($!order.state==0||$!order.state==6||$!order.state==5)
	                                        <a class="label label-important" data-toggle="modal" href="#tuihuo" >手动退货操作</a>
                                            <div class="modal hide" id="tuihuo" style="width:320px;margin-left: -160px;" aria-hidden="true">
                                              <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal">×</button>
                                                <h3>提示</h3>
                                              </div>
                                              <div class="modal-body ">
                                                <p style="text-align:center;">确认退货吗？</p>
                                              </div>
                                              <div class="modal-footer"> <a href="javascript:;" class="btn btn-primary" data-dismiss="modal"onclick="javascript:commitApplyRefund(1,$!{orderLine.itemId}),#formatAmount($!{orderLine.payPrice})">确定</a> <a href="javascript:;" class="btn" data-dismiss="modal">关闭</a> </div>
                                            </div>
	                                  #end
	                               #end
									#end
	                          </td>
	                          <td class="price">
	                            <p class="special-num">￥#formatAmount($!{orderLine.payUnitPrice})</p>
	                          </td>
							  <td><p>￥#formatAmount($!{orderLine.payPmtPrice})</p></td>
                              <td><p><span class="special-num">$!{orderLine.allocatedCount}</span>件</p></td>
							  <td>
                                  优惠券抵用金额：￥#formatAmount($!{orderLine.payCouponActPrice})</br>
                                  妈豆抵用金额：￥#formatAmount($!{orderLine.payMbeanPrice})</br>
                                  GB积分抵用金额：￥#formatAmount($!{orderLine.payGbPrice})</br>
                                  MC积分抵用金额：￥#formatAmount($!{orderLine.payMothercarePrice})</br>
                                  全场满减金额：￥#formatAmount($!{orderLine.pmtAllReducePrice})</br>
                                  部分满减金额：￥#formatAmount($!{orderLine.pmtPartReducePrice})</br>
                                  组合促销金额：￥#formatAmount($!{orderLine.pmtGroupPrice})</br>
                                  直降促销金额：￥#formatAmount($!{orderLine.pmtSalePrice})</br>
                                  VIP会员优惠：￥#formatAmount($!{orderLine.payVipReducePrice})</br>
							  </td>
	                          <td class="source">
	                          	<p>
                                #if($order.deliveryWay == 1)
	                              	<span class="label label-success"><s class="icon-exclamation-sign"></s> 门店配送</span>
	                              #elseif($order.deliveryWay == 2)
	                              	<span class="label label-warning"><s class="icon-exclamation-sign"></s> 上门自提</span>
	                              #elseif($order.deliveryWay == 3)
	                              	<span class="label label-inverse"><s class="icon-exclamation-sign"></s> 快递配送</span>
	                              #end
                              </p>
							  <p>
								#if($order.warehouseType == 0)
        							$!order.shopName
        						#else
        							$!order.stockName
        						#end
                              </p>
                              </td>
	                          <td class="amount">
	                            <p class="special-num"><strong>#formatAmount($!{orderLine.payPrice})</strong></p>
	                          </td>
	                          <td class="status">
								  #if($order.state == 0) 
                                    <span class="label label-success">已完成</span>
                                  #elseif ($order.state == 1)
                                    <span class="label">已失效</span>
                                  #elseif ($order.state == 2)
        							<span class="label">已取消</span>
                                  #elseif ($order.state == 3)
                                    <span class="label label-warning">待付款</span>
                                  #elseif ($order.state == 4)
        							<span class="label label-inverse">待发货</span>
                                  #elseif ($order.state == 5)
                                    <span class="label label-warning">已发货</span>
                                  #elseif ($order.state == 6)
                                    <span class="label label-info">待评价</span>
                                  #elseif ($order.state == 7)
                                    <span class="label">初始状态</span>
                                  #elseif ($order.state == 8)
    								<span class="label label-important">已删除</span>
								  #elseif ($order.state == 9)
									<p><span class="label label-important">已全部退款退货</span></p>
                                  #end
	                          </td>
	                        </tr>
                          #end
	                      </tbody>
	                    </table>
	                    #end

                      #if($refundOrderLines.size() && $refundOrderLines.size() >= 1)
	                    <table class="table table-text-center table-order">
	                    	<thead>
				                  <tr>
				                    <th class="text-left">商品</th>
				                    <th>单价(元)</th>
									<th>促销价</th>
                                    <th>数量</th>
									<th>优惠</th>
				                    <th>来源</th>
				                    <th>实付款(元)</th>
				                    <th>订单状态</th>
				                  </tr>
				                </thead>
	                      <tbody>
	                      	<tr class="sep-row"><td colspan="5"></td></tr>
	                      	<tr class="order-hd">
		                        <td class="text-left column">
		                          <span class="buyers">买家：$!{order.consigneeName}</span>
	                            <span class="phone">手机：$!{order.consigneePhone}</span>
		                        </td>
                                <td colspan="9"></td>
								<td class="text-right"></td>
		                      </tr>
	                        #foreach($orderLine in $refundOrderLines)
	                        <tr class="order-bd">
	                        	<td class="text-left baobei">
	                            <a class="pic" href="javascript:;"><img src="$goodsImagePath/$!{orderLine.picName}"></a>
	                            <div class="desc">
	                              <p><a class="baobei-name" href="javascript:;">$!{orderLine.itemName}</a></p>
	                              <small>$!{orderLine.spec}</small>
	                            </div>
	                          </td>
	                          <td class="price">
	                            <p class="special-num">#formatAmount($!{orderLine.payUnitPrice})</p>
	                          </td>
							  <td><p>￥#formatAmount($!{orderLine.payPmtPrice})</p></td>
                              <td><p><span class="special-num">$!{orderLine.allocatedCount}</span>件</p></td>
							  <td>
								优惠券抵用金额：￥#formatAmount($!{orderLine.payCouponActPrice})</br>
								妈豆抵用金额：￥#formatAmount($!{orderLine.payMbeanPrice})</br>
								GB积分抵用金额：￥#formatAmount($!{orderLine.payGbPrice})</br>
								MC积分抵用金额：￥#formatAmount($!{orderLine.payMothercarePrice})</br>
								全场满减金额：￥#formatAmount($!{orderLine.pmtAllReducePrice})</br>
								部分满减金额：￥#formatAmount($!{orderLine.pmtPartReducePrice})</br>
								组合促销金额：￥#formatAmount($!{orderLine.pmtGroupPrice})</br>
								直降促销金额：￥#formatAmount($!{orderLine.pmtSalePrice})</br>
							  </td>
	                          <td class="source">
	                          	<p data-original-title="
                              	#if($order.warehouseType == 0)
        							$!order.shopName
        						#else
        							$!order.stockName
        						#end" class="tip-left">
                                #if($order.deliveryWay == 1)
	                              	<span class="label label-success"><s class="icon-exclamation-sign"></s> 门店配送</span>
	                              #elseif($order.deliveryWay == 2)
	                              	<span class="label label-warning"><s class="icon-exclamation-sign"></s> 上门自提</span>
	                              #elseif($order.deliveryWay == 3)
	                              	<span class="label label-inverse"><s class="icon-exclamation-sign"></s> 快递配送</span>
	                              #end
                              </p>

                                  <p>
                                      #if($order.warehouseType == 0)
                                      $!order.shopName
                                  #else
                                          $!order.stockName
                                      #end
                                  </p>
                              </td>
	                          <td class="amount">
	                            <p class="special-num"><strong>#formatAmount($!{orderLine.payPrice})</strong></p>
	                          </td>
	                         <td class="status">
								 #if($!orderLine.refundLine)
                                     <p><a class="btn btn-danger btn-mini" href="$!{request.getContextPath()}/order/refundOrderDetail.do?orderNo=$orderLine.orderNo&itemId=$orderLine.itemId">跟踪退款退货</a></p>
                                     <p>当前退款状态:
										 #if($orderLine.refundLine.refundShiftStatus == 0)
											 #if($orderLine.refundLine.status == 5 || $orderLine.refundLine.status == 6
											 || $orderLine.refundLine.status == 8 || $orderLine.refundLine.status == 10)
                                                 退款关闭
											 #elseif($orderLine.refundLine.status == 3)
                                                 处理中
											 #elseif($orderLine.refundLine.status == 4)
                                                 退款完成
											 #else
												 处理中
											 #end
										 #elseif($orderLine.refundLine.refundShiftStatus == 1)
											 #if($orderLine.refundLine.status == 5 || $orderLine.refundLine.status == 6
											 || $orderLine.refundLine.status == 8 || $orderLine.refundLine.status == 10)
                                                 退款关闭
											 #elseif($orderLine.refundLine.payStatus == 3)
                                                 处理中
											 #elseif($orderLine.refundLine.payStatus == 4)
                                                 退款完成
											 #else
                                                 处理中
											 #end
										 #end
                                     </p>
                                     <p>退款金额:#formatAmount($orderLine.refundLine.refundAmount)</p>
								 #else
									 无退货退款
								 #end
                              </td>
	                        </tr>
                          #end
	                      </tbody>
	                    </table>
	                    #end
                  </dd>
                </dl>
              </div>
            </div>
            #if($distributions.size())
            <div class="widget-title"><a href="#order-3" data-toggle="collapse"><span class="icon"><i class="icon-plane"></i></span><h5>配送信息</h5></a></div>
            <div id="order-3" class="collapse in">
            	<div class="widget-content">
              #foreach($distribution in $distributions)
                #if($distribution.distributionType == 1)
                <dl>
                	<dt>门店配送</dt>
                  <dd>
                  	<p><strong>配送人：</strong>$!{distribution.distributionPeople}</p>
                    <p><strong>联系电话：</strong>$!{distribution.contactPhone}</p>
                    <p><strong>预计到达时间：</strong>$!date.format('yyyy-MM-dd HH:mm',$!distribution.predictTime)</p>
                  </dd>
                </dl>
                #elseif($distribution.distributionType == 2)
                <dl>
                	<dt>$!{distribution.expressName}</dt>
                  <dd>
                    <p><strong>货运单号：</strong>$!{distribution.distributionDeliveryNumber}</p>
                    <div>
                    	<strong>商品信息：</strong>
                    	<ol>
                      	#foreach($goodsDistribution in $distribution.goodsDistributions)
	                      <li>$!{goodsDistribution.itemName} x$!{goodsDistribution.qty}件</li>
                        #end
	                    </ol>
                    </div>
                    <div>
                    	<strong>订单跟踪：</strong>
                      <a href="javascript:;" onclick="InquireKD(this, '$!{distribution.expressCode}', '$!{distribution.distributionDeliveryNumber}')" class="label label-warning">点击查看物流信息</a>
                    	<ul id="kd-$!{distribution.distributionDeliveryNumber}"></ul>
                    </div>
                  </dd>
                </dl>
                #end
              #end
              </div>
            </div>
            #end
            #if($!orderComment)
            <div class="widget-title"><a href="#order-4" data-toggle="collapse"><span class="icon"><i class="icon-star"></i></span><h5>评价信息</h5></a></div>
            <div id="order-4" class="collapse in">
            	<div class="widget-content table-comment">
              	<dl>
                    <dt>订单评价</dt>
                  <dd>
                    <p><strong>服务态度：</strong><span class="star"><s class="s-$!{orderComment.serviceScore}"></s></span></p>
                    #if($!orderComment.deliveryWay != 2)
                    <p><strong>发货速度：</strong><span class="star"><s class="s-$!{orderComment.deliverScore}"></s></span></p>
                    #end
                      <p><strong>评价内容：</strong>$!{orderComment.content}</p>
                  </dd>
                </dl>
				#if($!orderComment.orderLineComments.size()>0)
              	<table class="table table-text-center">
                  <thead>
                    <tr>
                      <th class="text-left">商品评价</th>
                      <th width="200">商品评分</th>
                    </tr>
                  </thead>
                  <tbody>
                  	#foreach($lineComment in $orderComment.orderLineComments)
                  	<tr>
                  		<td class="text-left">
                      	<div class="order clearfix">
                        	<div class="pic">
							<img src="$!{goodsImagePath}$!{lineComment.picName}">
							</div>
                          <div class="desc">
                            <p>$!{lineComment.goodsName}</p>
                            <small>价格：#formatAmount($!{lineComment.price})元</small>
                          </div>
                        </div>
                      	<div class="photo">
							#foreach ($element in $lineComment.pictures.split(","))
								<img src="$!member_evaluation_pic$!order.memberId/$element">
							#end
						</div>
                      	<div class="alert alert-info">
                        	<strong>评价内容：</strong>
                          $!{lineComment.content}
                        </div>
                        #if($!{lineComment.bufferContent})
                        <div class="alert alert-info">
                        	<strong>追加评价：</strong>
                          $!{lineComment.bufferContent}
                        </div>
						<div class="photo">
							#foreach ($element in $lineComment.bufferPictures.split(","))
								<img src="$!member_evaluation_pic$!order.memberId/$element">
							#end
						</div>
                        #end
                        #if($!{lineComment.shopReplyContent})
                        <div class="alert alert-success">
                        	<strong>门店回复：</strong>
                          $!{lineComment.shopReplyContent}
                        </div>
                        #else
                        	#if($!{lineComment.content})
                          <a href="javascript:showReply($!{order.orderNo}, $!{lineComment.itemNumId});" class="btn btn-success">门店回复</a>
                          #end
                        #end
                      </td>
                  		<td><p class="star"><s class="s-$!{lineComment.rating}"></s></p></td>
                  	</tr>
                    #end
                  </tbody>
                </table>
				#end
              </div>
            </div>
            #end
          </div>
        </div>
      </div>
    </div>
    

<!-- 门店回复 -->
<div class="modal hide" id="reply-stores" aria-hidden="true">
  <div class="modal-header"><button type="button" class="close" data-dismiss="modal">×</button><h3>门店回复</h3></div>
  <div class="modal-body nopadding">
   	<div class="form-horizontal form-horizontal-inline">
    	<div class="control-group">
        <label class="control-label">回复内容：</label>
        <div class="controls">
          <textarea id="orderContent" maxlength="255"></textarea>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer"><a class="btn btn-success" href="javascript:getReply();">确定</a> <a data-dismiss="modal" class="btn" href="javascript:;">关闭</a> </div>
</div>

<!--modal container-->
<div class="js-tmp-modal modal modal-lg hide fade">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3></h3>
    </div>
    <div class="modal-body nopadding">
        <form id="msg-form" class="form-horizontal">
			<input name="cOrderNo" value=" $!{order.orderNo}" type="hidden">
			<input id="cProofPics" name="cProofPics" type="hidden"/>
            <div class="control-group">
                <label class="control-label"><i>*</i>赔付金额：</label>
                <div class="controls">
                    <input type="text" name="cPrice"/>
                    输入的赔付金额为正整数
                </div>
            </div>
            <div class="control-group">
                <label class="control-label"><i>*</i>姓名：</label>
                <div class="controls">
                    <input type="text" name="cPayName"/>
                </div>
            </div>
            <div class="control-group">
                <label class="control-label"><i>*</i>支付宝账号：</label>
                <div class="controls">
                    <input type="text" name="cPayAccount"/>
                </div>
            </div>
            <div class="control-group">
                <label class="control-label">费用承担方：</label>
                <div class="controls">
                    妈妈好平台先行垫付，最终总部承担
				</div>
            </div>
            <div class="control-group">
                <label class="control-label"><i>*</i>赔付原因：</label>
                <div class="controls">
					<select id="compensateCaseSelect">
						<option value="商品配件破损，无法维修">商品配件破损，无法维修</option>
						<option value="商品缺少配件，无法补发">商品缺少配件，无法补发</option>
                        <option value="其他">其他</option>
					</select>
					<input id="compensateCaseInput" type="text"/>
                    <input id="cApplyCase" name="cApplyCase" type="hidden"/>
                </div>
            </div>
            <div class="control-group">
                <label class="control-label"><i>*</i>上传凭证：</label>
                <div class="controls">
                    <ul class="thumbnails up-load-img main">
						#if($!{planData.planPics}!='')
							#set($plist=$planData.planPics.split(','))
							#foreach($pic in $plist)
                                <li>
                                    <img src="$imgpath$pic">
                                    <div class="actions">
                                        <a class="js-remove" href="javascript:;" fileName="$pic">
                                            <i class="icon-remove"></i>
                                        </a>
                                    </div>
                                </li>
							#end
						#end
                    </ul>
                    <div class="option">
                        <div>
							<span class="up-photo">
								<input name="stylePic" id="stylePic-hidden" type="hidden" value=""/>
								<div class="up-btn mult-up-btn" data-id="stylePic">
									<a href="javascript:;" id="stylePic" class="btn">上传图片</a>
								</div>
							</span>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="javascript:commit();">确定</button>
        <button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">关闭</button>
    </div>
</div>

<script type="text/javascript">
	Matrix.Nav({"menu": 116, "cmenu": 143});
	var replyPOP = $("#reply-stores"),
	getVal = {};
	function showReply(oid, tid){
		getVal.orderNo = oid;
		getVal.itemNumId = tid;
		replyPOP.modal('show');
	};
	function getReply(){
		var orderContent = $("#orderContent");
		if(isForm.isTrim(orderContent.val())){
			Toast.show("请填写回复内容");
			orderContent.focus();
			return;
		}
		getVal.content = orderContent.val();
		Matrix.JSON({
			showLoad: true,
			type: "POST",
			val: getVal,
			url: root + "/order/shopReplyOrder.do",
			fun: function(msg){
				if(msg){
					Toast.show("提交成功");
					window.location.reload();
				}else{
					Toast.show({template: "回复失败，请重新回复", auto: false});
				}
			}
		});
	};
	
	var status = "$!{order.state}", progress = $(".order-progress"), lis = progress.find("li"), l = 0;
	// class="active"
	if(status == 3){
		progress.addClass("state-1");
		l = 1;
	}else if(status == 4){
		progress.addClass("state-2");
		l = 2;
	}else if(status == 5){
		progress.addClass("state-3");
		l = 3;
	}else if(status == 6){
		progress.addClass("state-4");
		l = 4;
	}else if(status == 0){
		progress.addClass("state-5");
		l = 5;
	}else if(status == 2 || status == 1 || status == 8 || status == 9){
		progress.addClass("state-5");
		l = 2;
	}
	for(var i = 0; i < l; i++){
		lis.eq(i).addClass("active");
	}
	
	// 快递信息查询;
	function InquireKD(obj, name, id){
        var orderNo=$!{order.orderNo};
		var elems = $("#kd-" + id);
		obj.remove();
		elems.html('<li class="label label-success">请稍后，我们正在为您加载数据…</li>');
		new Matrix.JSON({
			val: {orderNo:orderNo,platformCode: name, waybillNumber: id},
			url: root + "/order/logisticsTracking.do",
			fun: function(msg){
				var arr = [];
				if(Number(msg.status) == 0){
					// 成功;

					// var data = msg.data.sort(function(a,b){return a.time - b.time});
          var data = msg.data;
					for(var i = 0; i < data.length; i++){
						arr.push('<li class="li-'+ i +'">' + data[i].time + ' ' + data[i].context + '</li>');
					}
				}
				else if(Number(msg.status) == 2){
					// 接口出现异常;
					arr.push('<li class="label">'+ msg.message +'</li>');
				}
				else{
					// 物流单暂无结果;
					arr.push('<li class="label">该单号暂无物流进展，请稍后再试，或检查公司和单号是否有误。</li>');
				}
				elems.html(arr.join(''));
			}
		});
	};

	//代拍退款、退款退货
	function commitApplyRefund(refundType,itemNumId,amount){
		var memberId=$!{order.memberId};
		var orderNo=$!{order.orderNo};
		var itemNumId=itemNumId;
		var refundType=refundType;
		var cause="七天无理由退货";
		var amount=amount;
		var remark="客服协助退货";
		var pic="2F105%2F3c6d4b53a81ca62ea304ca461c2272ef.png";

		 Matrix.JSON({
				showLoad: true,
				type: "POST",
				val: {memberId:memberId,orderNo:orderNo,itemId:itemNumId,refundType:refundType,cause:cause,amount:amount,remark:remark,pic:pic},
				url: root + "/order/commitApplyRefund.do",
				fun: function(data){
					if(data.success==true){
						Toast.show("提交成功");
						window.location.reload();
					}else{
						Toast.show({template: data.msg, auto: false});
					}
				}
			 });
	}

	/************************************************************小额赔付相关*************************************************************/
    /*加载iframe*/
    function loadIframe(info){
        var self = $(".js-tmp-modal");
        self.find(".modal-header h3").text(info.title);
        self.modal("show");
        return false;
    }

    function add(obj) {
        //加载iframe
        var info = {
            title: "小额赔付"
        };
        loadIframe(info);
    }

	$("#compensateCaseInput").hide();
	$("#compensateCaseSelect").bind("change",function(){
		var compensateCase = $(this).val();
		if(compensateCase == "其他"){
            $("#compensateCaseInput").show()
		}else{
            $("#compensateCaseInput").hide()
		}
	});

    //文件上传  商品主图,可上传多张
    $(".mult-up-btn").each(function () {
        var thas = $(this), _target = thas.closest('.controls').find('.up-load-img');
        thas.children().uploadify({
            uploader: root + '/oss/uploadFiles.do',
            formData:{type: 11},
            swf: root + '/res/uploadify/uploadify.swf',
            queueID: 'null', // 上传进度列表;
            fileTypeDesc: "jpg",
            fileTypeExts: '*.jpg;*.png', //控制可上传文件的扩展名，启用本项时需同时声明fileTypeDesc
            multi: true,
            queueSizeLimit: 5,
            wmode: "transparent",
            buttonText: '选择图片',
            width: "100%",
            height: "100%",
            overrideEvents: ['onSelectError'],
            onUploadStart: function (file) {
                // 进行中;
                if (_target.find('li').length >= 5) {
                    Toast.show("最多只能上传5张图片");
                    thas.children().uploadify('cancel');
                } else {
						_target.append('<li data-index="' + file.index + '"></li>');
                }
            },
            onUploadSuccess: function (file, data, response) {
                //上传完成时触发（每个文件触发一次）;
                var data = JSON.parse(data);
                if (!data.success) {
                    Toast.show(data.msg || '上传失败');
                } else {
                    var imgUrl = "${imgpath}" + data.fileName;
                    var _item = _target.find('li[data-index="'+file.index+'"]');
                    var html = '<img alt="" src="' + imgUrl + '"><div class="actions"><a class="js-remove" href="javascript:;" fileName="' + data.fileName + '"><i class="icon-remove"></i></a></div>';
                    _item.append(html);
                }
            },
            onSelectError: function (file, errorCode, errorMsg) {
                if (errorCode == -100) {
                    Toast.show("上传的文件数量已经超出系统限制的文件！");
                    return false;
                } else if (errorCode == -110) {
                    Toast.show("文件 [" + file.name + "] 大小超出系统限制的大小！");
                    return false;
                } else if (errorCode == -120) {
                    Toast.show("文件 [" + file.name + "] 大小异常！");
                    return false;
                } else {
                    Toast.show("文件 [" + file.name + "] 类型不正确！");
                    return false;
                }

            }
        });
    });


    function commit() {
        /*表单验证*/
        var _form = $("#msg-form"),
                cPrice = _form.find("[name='cPrice']"),
                cPayName = _form.find("[name='cPayName']"),
                cPayAccount = _form.find("[name='cPayAccount']");

		var arr = [];
		$.each($('.up-load-img li'), function () {
			var _this = $(this);
			if(_this.find('.js-remove').attr('filename') != ""){
                arr.push(_this.find('.js-remove').attr('filename'));
			}
        });
		var imgStr = arr.join(',');//理赔原因图片
		$("#cProofPics").val(imgStr);

		if(arr.length==0){
            Toast.show("请上传凭证！");
            return false;
		}

        if(isForm.isTrim(cPrice.val())){
            showEmptyTips(cPrice);
            return false;
        }
        if(!isForm.isImp(cPrice.val())){
            Toast.show("赔付金额必须为整数");
            return false;
        }

        if(isForm.isTrim(cPayName.val())){
            showEmptyTips(cPayName);
            return false;
        }

        if(isForm.isTrim(cPayAccount.val())){
            showEmptyTips(cPayAccount);
            return false;
        }

		var cApplyCase = "";
        var compensateCase = $("#compensateCaseSelect").val();
        if(compensateCase == "其他"){
            cApplyCase = $("#compensateCaseInput").val();
        }else{
            cApplyCase = $("#compensateCaseSelect").val();
        }
		if(cApplyCase==""){
            Toast.show("请选择原因");
            return false;
		}
		$("#cApplyCase").val(cApplyCase);

        /*ajax提交数据*/
        $.ajax({
            url: '$!{request.getContextPath()}/order/compensateSave.do',
            type: 'post',
            dataType: 'json',
            data: $("#msg-form").serialize(),
            success: function (result) {
                data = eval(result);
                if (data.success == true) {
                    Toast.show({
                        template: "添加成功",
                        second: 1000
                    });
                    window.location.reload();
                }else{
                    Toast.show(data.msg);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                Toast.show("[服务器异常]" + XMLHttpRequest.status);
            }
        });
    }
    //显示不能为空提示
    function showEmptyTips(obj){
        Toast.show(obj.closest(".control-group").find(".control-label").text().replace(/[\s*:：]/g,"")+"不能为空");
        obj.focus();
    }

    var page = {
        removePic: function () {
            var o = page.ele, c = page.info;
            var _this = $(this), _target = _this.closest('li');
            var fileName = _this.attr("fileName");
            if (!fileName) return false;
            if (_this.closest('.up-load-img').hasClass('custom')) {
                var styleId = _this.data('style-id');
                styleId && page.data.deleteStyleIds.push(styleId);
                page.data.deleteStyleImgs.push(fileName);
            }
				_target.fadeOut(function () {
				_target.remove();
			});
        }
	};

    /**
     * 代拍 手动确认收货
	 * @param orderNo
     */
	function confirmReceipt(orderNo){
        Matrix.JSON({
            showLoad: true,
            type: "POST",
            val: {orderNo:orderNo},
            url: root + "/order/confirmReceipt.do",
            fun: function(data){
                if(data.success==true){
                    Toast.show("提交成功");
                    window.location.reload();
                }else{
                    Toast.show({template: data.msg, auto: false});
                }
            }
        });
	}

    // 删除图片
    $(".thumbnails").on("click", ".js-remove", page.removePic);
</script>